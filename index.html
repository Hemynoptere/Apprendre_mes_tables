import React, { useState, useEffect, useRef } from â€˜reactâ€™;
import { Volume2, RotateCcw, Home, Play, Sparkles } from â€˜lucide-reactâ€™;

const TablesRevisionApp = () => {
const [page, setPage] = useState(â€˜welcomeâ€™);
const [prenom, setPrenom] = useState(â€™â€™);
const [operation, setOperation] = useState(â€™+â€™);
const [speed, setSpeed] = useState(1000);
const [voice, setVoice] = useState(â€˜femaleâ€™);
const [table, setTable] = useState(5);
const [isRandom, setIsRandom] = useState(false);
const [spinning, setSpinning] = useState(false);
const [results, setResults] = useState([]);
const [currentIndex, setCurrentIndex] = useState(0);
const [isReading, setIsReading] = useState(false);
const [highlightIndex, setHighlightIndex] = useState(-1);
const synth = useRef(window.speechSynthesis);

const operations = [
{ symbol: â€˜+â€™, name: â€˜Additionâ€™ },
{ symbol: â€˜-â€™, name: â€˜Soustractionâ€™ },
{ symbol: â€˜Ã—â€™, name: â€˜Multiplicationâ€™ },
{ symbol: â€˜Ã·â€™, name: â€˜Divisionâ€™ }
];

const speeds = [
{ value: 2000, label: â€˜Lentâ€™ },
{ value: 1000, label: â€˜Normalâ€™ },
{ value: 500, label: â€˜Rapideâ€™ }
];

const spinWheel = () => {
setSpinning(true);
let spins = 0;
const maxSpins = 20;

```
const interval = setInterval(() => {
  setTable(Math.floor(Math.random() * 13));
  spins++;
  
  if (spins >= maxSpins) {
    clearInterval(interval);
    setSpinning(false);
    setIsRandom(true);
  }
}, 100);
```

};

const calculate = (num1, op, num2) => {
switch (op) {
case â€˜+â€™: return num1 + num2;
case â€˜-â€™: return num1 - num2;
case â€˜Ã—â€™: return num1 * num2;
case â€˜Ã·â€™: return Math.floor(num1 / num2);
default: return 0;
}
};

const speak = (text, onEnd) => {
if (synth.current.speaking) {
synth.current.cancel();
}

```
const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'fr-FR';
utterance.rate = 0.9;
utterance.pitch = voice === 'female' ? 1.2 : 0.8;

utterance.onend = () => {
  if (onEnd) onEnd();
};

synth.current.speak(utterance);
```

};

const formatOperation = (op) => {
const opWords = {
â€˜+â€™: â€˜plusâ€™,
â€˜-â€™: â€˜moinsâ€™,
â€˜Ã—â€™: â€˜foisâ€™,
â€˜Ã·â€™: â€˜divisÃ© parâ€™
};
return opWords[op] || op;
};

const handleWelcomeNext = () => {
if (prenom.trim()) {
const message = `Du courage ${prenom} ! Je vais te prÃ©senter les tables que tu veux rÃ©viser. Tu devras dire le rÃ©sultat avant qu'il ne s'affiche et Ã  la fin rÃ©pÃ©ter toute la table avec moi.`;
speak(message, () => {
setTimeout(() => setPage(â€˜choiceâ€™), 500);
});
}
};

const startRevision = () => {
const newResults = [];
for (let i = 0; i <= 12; i++) {
const result = calculate(table, operation, i);
newResults.push({
operation: `${table} ${operation} ${i}`,
result: result,
text: `${table} ${formatOperation(operation)} ${i} Ã©gale ${result}`
});
}
setResults(newResults);
setCurrentIndex(0);
setPage(â€˜revisionâ€™);
setIsReading(true);
};

useEffect(() => {
if (page === â€˜revisionâ€™ && isReading && currentIndex < results.length) {
const current = results[currentIndex];

```
  speak(current.text.split('Ã©gale')[0], () => {
    setTimeout(() => {
      speak(`Ã©gale ${current.result}`, () => {
        setTimeout(() => {
          setCurrentIndex(prev => prev + 1);
        }, 300);
      });
    }, speed);
  });
} else if (page === 'revision' && isReading && currentIndex === results.length) {
  setTimeout(() => {
    speak(`Bravo ${prenom} ! Maintenant rÃ©pÃ¨te toute la table avec moi.`, () => {
      setTimeout(() => rereadAll(), 1000);
    });
  }, 1000);
}
```

}, [currentIndex, isReading, page]);

const rereadAll = () => {
let index = 0;

```
const readNext = () => {
  if (index < results.length) {
    setHighlightIndex(index);
    speak(results[index].text, () => {
      index++;
      setTimeout(readNext, 300);
    });
  } else {
    setHighlightIndex(-1);
    setIsReading(false);
    speak(`Excellent ${prenom} ! Tu as super bien travaillÃ© !`);
  }
};

readNext();
```

};

const restart = () => {
synth.current.cancel();
setCurrentIndex(0);
setHighlightIndex(-1);
setIsReading(true);
};

const newChoice = () => {
synth.current.cancel();
setPage(â€˜choiceâ€™);
setResults([]);
setCurrentIndex(0);
setHighlightIndex(-1);
setIsReading(false);
};

const quit = () => {
synth.current.cancel();
speak(`Au revoir ${prenom} ! Ã€ bientÃ´t !`, () => {
setTimeout(() => window.close(), 2000);
});
};

if (page === â€˜welcomeâ€™) {
return (
<div className=â€œmin-h-screen bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-300 p-4 flex items-center justify-centerâ€ style={{ fontFamily: â€˜Arial, sans-serifâ€™ }}>
<div className="max-w-2xl w-full bg-white rounded-3xl shadow-2xl p-8 border-8 border-rainbow">
<div className="text-center mb-6">
<Sparkles className="inline-block text-yellow-500 mb-3" size={56} />
<h1 className="text-4xl font-bold mb-3 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600 bg-clip-text text-transparent">
Bienvenue !
</h1>
<p className="text-xl text-gray-700 mb-6">
Comment tâ€™appelles-tu ?
</p>
</div>

```
      <input
        type="text"
        value={prenom}
        onChange={(e) => setPrenom(e.target.value)}
        onKeyPress={(e) => e.key === 'Enter' && handleWelcomeNext()}
        placeholder="Ton prÃ©nom"
        className="w-full text-2xl text-center p-5 border-4 border-purple-400 rounded-2xl mb-6 focus:outline-none focus:border-pink-500 transition-all"
        style={{ fontFamily: 'Arial, sans-serif' }}
        autoFocus
      />

      <button
        onClick={handleWelcomeNext}
        disabled={!prenom.trim()}
        className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white py-5 rounded-2xl font-bold text-2xl hover:from-green-500 hover:to-blue-600 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
        style={{ fontFamily: 'Arial, sans-serif' }}
      >
        <Play size={28} />
        C'est parti !
      </button>
    </div>
  </div>
);
```

}

if (page === â€˜choiceâ€™) {
return (
<div className=â€œmin-h-screen bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-300 p-2 flex items-centerâ€ style={{ fontFamily: â€˜Arial, sans-serifâ€™ }}>
<div className="max-w-2xl w-full mx-auto bg-white rounded-2xl shadow-2xl p-4 border-4 border-rainbow">
<h1 className="text-2xl font-bold text-center mb-1 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
Bonjour {prenom} ! ðŸŒŸ
</h1>
<p className="text-base text-center mb-2 text-gray-600">
Choisis ta table Ã  rÃ©viser
</p>

```
      <div className="space-y-2">
        {/* OpÃ©ration */}
        <div>
          <label className="block text-lg font-bold mb-1 text-purple-700">
            âž• OpÃ©ration
          </label>
          <div className="grid grid-cols-4 gap-2">
            {operations.map(op => (
              <button
                key={op.symbol}
                onClick={() => setOperation(op.symbol)}
                className={`p-3 rounded-xl text-2xl font-bold transition-all ${
                  operation === op.symbol
                    ? 'bg-gradient-to-br from-orange-400 to-pink-500 text-white shadow-xl scale-110'
                    : 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:scale-105'
                }`}
              >
                {op.symbol}
              </button>
            ))}
          </div>
        </div>

        {/* Vitesse */}
        <div>
          <label className="block text-lg font-bold mb-1 text-blue-700">
            âš¡ Vitesse
          </label>
          <div className="grid grid-cols-3 gap-2">
            {speeds.map(s => (
              <button
                key={s.value}
                onClick={() => setSpeed(s.value)}
                className={`p-2 rounded-xl text-base font-bold transition-all ${
                  speed === s.value
                    ? 'bg-gradient-to-br from-blue-400 to-cyan-500 text-white shadow-xl scale-105'
                    : 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:scale-105'
                }`}
              >
                {s.label}
              </button>
            ))}
          </div>
        </div>

        {/* Voix */}
        <div>
          <label className="block text-lg font-bold mb-1 text-green-700">
            ðŸŽ¤ Voix
          </label>
          <div className="grid grid-cols-2 gap-2">
            <button
              onClick={() => setVoice('male')}
              className={`p-2 rounded-xl text-base font-bold transition-all ${
                voice === 'male'
                  ? 'bg-gradient-to-br from-green-400 to-teal-500 text-white shadow-xl scale-105'
                  : 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:scale-105'
              }`}
            >
              ðŸ‘¨ Homme
            </button>
            <button
              onClick={() => setVoice('female')}
              className={`p-2 rounded-xl text-base font-bold transition-all ${
                voice === 'female'
                  ? 'bg-gradient-to-br from-pink-400 to-rose-500 text-white shadow-xl scale-105'
                  : 'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:scale-105'
              }`}
            >
              ðŸ‘© Femme
            </button>
          </div>
        </div>

        {/* Table */}
        <div>
          <label className="block text-lg font-bold mb-1 text-purple-700">
            ðŸ”¢ Table
          </label>
          <div className="flex items-center gap-2">
            <div className="flex-1">
              <div className={`text-center p-4 rounded-xl ${
                spinning ? 'bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400 animate-pulse' : 'bg-gradient-to-br from-purple-200 to-pink-200'
              }`}>
                <div className="text-5xl font-bold text-purple-800">
                  {table}
                </div>
              </div>
              <input
                type="range"
                min="0"
                max="12"
                value={table}
                onChange={(e) => {
                  setTable(parseInt(e.target.value));
                  setIsRandom(false);
                }}
                className="w-full mt-1 h-2"
                disabled={spinning}
              />
            </div>
            <button
              onClick={spinWheel}
              disabled={spinning}
              className="px-3 py-3 bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-xl text-base font-bold hover:from-yellow-500 hover:to-orange-600 transition-all disabled:opacity-50 shadow-lg whitespace-nowrap"
            >
              {spinning ? 'ðŸŽ°' : 'ðŸŽ²'} Surprise!
            </button>
          </div>
        </div>

        {/* Boutons */}
        <div className="flex gap-2 pt-1">
          <button
            onClick={startRevision}
            className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-bold text-lg hover:from-green-600 hover:to-emerald-700 transition-all shadow-xl flex items-center justify-center gap-2"
          >
            <Play size={20} />
            C'est parti !
          </button>
          <button
            onClick={quit}
            className="px-4 bg-gradient-to-br from-red-500 to-red-600 text-white py-3 rounded-xl font-bold text-base hover:from-red-600 hover:to-red-700 transition-all shadow-lg"
          >
            Quitter
          </button>
        </div>
      </div>
    </div>
  </div>
);
```

}

return (
<div className=â€œmin-h-screen bg-gradient-to-br from-green-200 via-blue-200 to-purple-300 p-2 flex items-centerâ€ style={{ fontFamily: â€˜Arial, sans-serifâ€™ }}>
<div className="max-w-4xl w-full mx-auto bg-white rounded-2xl shadow-2xl p-2 border-2 border-rainbow">
<h1 className="text-lg font-bold text-center mb-0 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
Allez {prenom} ! ðŸ’ª
</h1>
<p className="text-sm text-center mb-1 text-gray-700 font-bold">
Table de {table} - {operations.find(op => op.symbol === operation)?.name}
</p>

```
    <div className="bg-gradient-to-br from-yellow-50 to-pink-50 rounded-xl p-1.5 mb-1.5 border-2 border-purple-200" style={{ maxHeight: 'calc(100vh - 160px)', overflowY: 'auto' }}>
      {results.map((item, index) => (
        <div
          key={index}
          className={`py-0.5 px-2 mb-0.5 rounded text-sm font-bold transition-all ${
            index < currentIndex
              ? 'opacity-100'
              : index === currentIndex
              ? 'opacity-100 bg-yellow-200 animate-pulse border border-yellow-400'
              : 'opacity-30'
          } ${
            highlightIndex === index
              ? 'bg-gradient-to-r from-blue-300 to-purple-300 scale-105 shadow-lg border border-blue-500'
              : 'bg-white'
          }`}
          style={{
            visibility: index <= currentIndex ? 'visible' : 'hidden',
            fontFamily: 'Arial, sans-serif'
          }}
        >
          <span className="text-gray-800">{item.operation}</span>
          {index < currentIndex && (
            <span className="text-blue-700"> = {item.result}</span>
          )}
        </div>
      ))}
    </div>

    <div className="flex gap-2">
      <button
        onClick={restart}
        disabled={isReading}
        className="flex-1 bg-gradient-to-br from-orange-500 to-red-500 text-white py-2 rounded-xl font-bold text-sm hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50 flex items-center justify-center gap-1 shadow-lg"
      >
        <RotateCcw size={16} />
        Recommencer
      </button>
      <button
        onClick={newChoice}
        className="flex-1 bg-gradient-to-br from-blue-500 to-purple-600 text-white py-2 rounded-xl font-bold text-sm hover:from-blue-600 hover:to-purple-700 transition-all flex items-center justify-center gap-1 shadow-lg"
      >
        <Home size={16} />
        Nouveau choix
      </button>
      <button
        onClick={quit}
        className="px-3 bg-gradient-to-br from-red-500 to-red-600 text-white py-2 rounded-xl font-bold text-sm hover:from-red-600 hover:to-red-700 transition-all shadow-lg"
      >
        Quitter
      </button>
    </div>
  </div>
</div>
```

);
};

export default TablesRevisionApp;
